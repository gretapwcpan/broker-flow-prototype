<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¶ Broker Flow Analytics Dashboard</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0; padding: 20px; background: #f8f9fa; line-height: 1.6;
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; text-align: center;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .metric { text-align: center; margin: 15px 0; }
        .metric-value { font-size: 2em; font-weight: bold; color: #2563eb; }
        .metric-label { color: #6b7280; font-size: 0.9em; }
        .opportunity { 
            padding: 10px; margin: 8px 0; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;
        }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { 
            background: #3b82f6; color: white; border: none; padding: 12px 24px; 
            border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px;
        }
        button:hover { background: #2563eb; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¶ Broker Flow Analytics</h1>
        <p>Real-time mortgage document insights and business intelligence</p>
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
            <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9em;">
                üìÑ Document Processing
            </span>
            <span style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; font-size: 0.9em;">
                üìä Live Analytics
            </span>
        </div>
    </div>

    <div id="status" class="status loading">Loading analytics data...</div>
    
    <div style="text-align: center; margin: 20px;">
        <button onclick="loadData()">üîÑ Refresh Data</button>
        <button onclick="openReactApp()">üöÄ Open React Dashboard</button>
    </div>

    <div id="dashboard" class="grid" style="display: none;">
        <!-- Executive Summary -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>üìä Executive Summary</h2>
            <div id="executive-summary"></div>
        </div>

        <!-- Borrower Insights -->
        <div class="card">
            <h3>üë• Borrower Analysis</h3>
            <div id="borrower-insights"></div>
        </div>

        <!-- Property Insights -->
        <div class="card">
            <h3>üè† Property Market</h3>
            <div id="property-insights"></div>
        </div>

        <!-- Portfolio Insights -->
        <div class="card" style="grid-column: 1 / -1;">
            <h3>üéØ Growth Opportunities</h3>
            <div id="opportunities"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let dashboardData = null;

        async function loadData() {
            const statusDiv = document.getElementById('status');
            const dashboardDiv = document.getElementById('dashboard');
            
            statusDiv.className = 'status loading';
            statusDiv.textContent = 'Loading analytics data...';
            dashboardDiv.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE_URL}/api/insights`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                dashboardData = await response.json();
                displayDashboard(dashboardData);
                
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `‚úÖ Analytics loaded successfully! Processing ${dashboardData.total_documents} documents`;
                dashboardDiv.style.display = 'grid';
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå Connection failed: ${error.message}<br><small>Make sure backend server is running on port 8000</small>`;
                showTroubleshooting();
            }
        }

        function displayDashboard(data) {
            // Executive Summary
            document.getElementById('executive-summary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div class="metric">
                        <div class="metric-value">${data.total_documents}</div>
                        <div class="metric-label">Documents Processed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${data.borrower_insights?.total_borrowers || 0}</div>
                        <div class="metric-label">Borrower Profiles</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${data.portfolio_insights?.risk_assessment?.overall_risk_level || 'N/A'}</div>
                        <div class="metric-label">Risk Level</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">100%</div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>
                <p style="text-align: center; font-style: italic; color: #6b7280;">
                    ${data.portfolio_insights?.executive_summary || 'Analytics summary not available'}
                </p>
            `;

            // Borrower Insights
            const borrower = data.borrower_insights;
            document.getElementById('borrower-insights').innerHTML = `
                <div class="metric">
                    <div class="metric-value">$${borrower?.income_analysis?.average_income?.toLocaleString() || 'N/A'}</div>
                    <div class="metric-label">Average Income</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${Math.round(borrower?.credit_score_analysis?.average_score || 0)}</div>
                    <div class="metric-label">Average Credit Score</div>
                </div>
                <div style="margin-top: 15px;">
                    <strong>Credit Distribution:</strong><br>
                    <small>
                        üü¢ Excellent: ${borrower?.credit_score_analysis?.excellent_credit || 0} | 
                        üîµ Good: ${borrower?.credit_score_analysis?.good_credit || 0} | 
                        üü° Fair: ${borrower?.credit_score_analysis?.fair_credit || 0}
                    </small>
                </div>
            `;

            // Property Insights
            const property = data.property_insights;
            document.getElementById('property-insights').innerHTML = `
                <div class="metric">
                    <div class="metric-value">$${Math.round(property?.market_overview?.average_property_value || 0).toLocaleString()}</div>
                    <div class="metric-label">Average Property Value</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${property?.market_overview?.total_properties_analyzed || 0}</div>
                    <div class="metric-label">Properties Analyzed</div>
                </div>
                ${property?.property_trends?.average_price_per_sqft ? `
                <div style="margin-top: 15px;">
                    <strong>Market Trends:</strong><br>
                    <small>Price per sq ft: $${Math.round(property.property_trends.average_price_per_sqft)}</small>
                </div>
                ` : ''}
            `;

            // Opportunities
            const opportunities = data.portfolio_insights?.growth_opportunities || [];
            document.getElementById('opportunities').innerHTML = opportunities.slice(0, 6).map(opp => 
                `<div class="opportunity">üí° ${opp}</div>`
            ).join('') || '<p>No specific opportunities identified yet.</p>';
        }

        function showTroubleshooting() {
            document.getElementById('dashboard').innerHTML = `
                <div class="card" style="grid-column: 1 / -1;">
                    <h3>üîß Troubleshooting</h3>
                    <p><strong>Backend API not accessible. Try these solutions:</strong></p>
                    <ol>
                        <li>Make sure backend server is running: <code>python backend/main.py</code></li>
                        <li>Test API directly: <a href="${API_BASE_URL}/health" target="_blank">${API_BASE_URL}/health</a></li>
                        <li>Check terminal for error messages</li>
                        <li>Try restarting both servers</li>
                    </ol>
                    <p><strong>Alternative access methods:</strong></p>
                    <ul>
                        <li><a href="${API_BASE_URL}/docs" target="_blank">API Documentation</a></li>
                        <li><a href="${API_BASE_URL}/api/insights" target="_blank">Raw Analytics Data</a></li>
                    </ul>
                </div>
            `;
            document.getElementById('dashboard').style.display = 'grid';
        }

        function openReactApp() {
            const urls = [
                'http://localhost:3001',
                'http://127.0.0.1:3001',
                'http://172.20.10.14:3001'
            ];
            
            urls.forEach((url, index) => {
                setTimeout(() => {
                    window.open(url, '_blank');
                }, index * 1000);
            });
        }

        // Auto-load data when page opens
        window.onload = () => {
            setTimeout(loadData, 500);
        };
    </script>
</body>
</html>